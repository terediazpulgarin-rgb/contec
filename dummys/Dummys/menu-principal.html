<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MENU PRINCIPAL DUMMYS</title>
  <style>
    body{font-family:Arial, sans-serif;background-image:url('imagenes/Dummys.png');background-size:cover;background-position:center;background-repeat:no-repeat;margin:0;padding:0;height:100vh;overflow:hidden;display:flex;user-select:none}
    body*,html{cursor:none!important}

    /* Clase dinámica para ocultar cursor */
    .no-cursor, .no-cursor * {
      cursor: none !important;
    }
    
    .contenido-principal{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative}
    .fondo-botones{position:absolute;background-color:rgba(222,222,222,.85);border-radius:15px;padding:20px;width:90%;max-width:900px;min-height:75vh;height:auto;margin-top:40px;border:2px solid rgba(0,0,0,.1);box-shadow:0 0 20px rgba(0,0,0,.2);display:flex;flex-direction:column;align-items:center;justify-content:flex-start;overflow-y:auto;z-index:1}

    .LINEAS{background:#ff0;font-size:40px;padding:20px;border:2px solid #080;border-radius:5px;font-weight:700;text-align:center;min-width:300px;box-shadow:0 4px 8px rgba(0,0,0,.2);margin:20px 0 10px;position:relative;z-index:2}
    .msg{margin:10px 0;text-align:center;color:#333;font-weight:700}
    .barrita{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:5px 0 10px;z-index:2}
    .btn-texto{width:200px;height:56px;font-weight:700;display:flex;align-items:center;justify-content:center;color:#080;border:2px solid #080;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,.2);background:#e9e9e9;user-select:none;transition:box-shadow .2s,transform .2s}
    .btn-azul{background:#0d47a1;color:#fff;border-color:#0d47a1}
    .btn-rojo{background:#b71c1c;color:#fff;border-color:#b71c1c}
    .btn-texto:hover{transform:scale(1.03);box-shadow:0 6px 12px rgba(0,0,0,.3)}

    .botones-sub{
      display:grid;
      grid-template-columns:repeat(7, minmax(90px,1fr));
      gap:10px;
      max-width:800px;
      width:100%;
      align-items:center;
      justify-content:center;
      position:relative;
      z-index:2;
      padding:15px
    }

    .botontexto{
      color:#080;border:2px solid #080;text-align:center;display:flex;align-items:center;justify-content:center;
      font-size:25px;margin:5px;padding:10px 8px;transition:.3s;border-radius:5px;
      width:auto;min-width:120px;max-width:100%;
      height:auto;min-height:60px;
      box-sizing:border-box;box-shadow:0 4px 8px rgba(0,0,0,.2);background:#eaeaea;user-select:none;position:relative;
      white-space:normal;word-break:break-word;overflow:visible;text-overflow:clip
    }
    .botontexto:hover{transform:scale(1.05);box-shadow:0 6px 12px rgba(0,0,0,.3)}

    #barra-lateral{position:relative;z-index:9999;width:250px;height:100vh;background-color:rgba(255,255,255,.8);display:flex;flex-direction:column;align-items:center;padding:10px;box-sizing:border-box;gap:10px}
    #barra-lateral img{width:150px;height:150px;transition:opacity .3s}
    #barra-lateral img:hover{opacity:.5}
    .panel-carpeta{width:200px;display:flex;flex-direction:column;gap:10px;align-items:stretch}

    .pizarron-disabled{opacity:.45;filter:grayscale(100%);pointer-events:none}
    .pizarron-hint{font-size:12px;color:#555;text-align:center;margin-top:-6px}

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:99999}
    .overlay.open{display:flex}
    .pad{background:rgba(255,255,255,.95);border-radius:16px;border:2px solid rgba(0,0,0,.15);box-shadow:0 12px 30px rgba(0,0,0,.35);width:min(420px,92%);padding:18px 16px}
    .pad-title{font-weight:900;text-align:center;margin-bottom:4px;font-size:22px}
    .pad-sub{font-weight:700;text-align:center;margin-bottom:12px;font-size:14px;color:#333}
    .pad-screen{height:48px;border:2px solid #0008;border-radius:10px;background:#ffeb3b;display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:900;letter-spacing:6px;margin:0 8px 12px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:0 8px}
    .key{height:56px;border-radius:12px;border:2px solid #0008;background:#fff;font-weight:900;font-size:22px;cursor:pointer;box-shadow:0 3px 10px rgba(0,0,0,.18);display:flex;align-items:center;justify-content:center;user-select:none}
    .key:active{transform:scale(.98)}
    .pad-actions{display:flex;gap:10px;justify-content:center;margin-top:12px;padding:0 8px}
    .btn-cancel,.btn-clear{height:46px;border-radius:12px;border:2px solid #0008;background:#fff;font-weight:900;font-size:16px;cursor:pointer;padding:0 14px}
    .btn-cancel:hover,.btn-clear:hover{background:#f5f5f5}

    .file-button{position:relative;overflow:hidden;text-align:center}
    .file-button input[type=file]{position:absolute;inset:0;width:100%;height:100%;opacity:0;cursor:pointer}

    @media (max-width:1200px){ .botones-sub{grid-template-columns:repeat(6, minmax(90px,1fr));} }
    @media (max-width:1024px){ .botones-sub{grid-template-columns:repeat(5, minmax(90px,1fr));} }
    @media (max-width:900px){ .botones-sub{grid-template-columns:repeat(4, minmax(90px,1fr));} }
    @media (max-width:768px){
      #barra-lateral{width:100%;height:auto;padding:10px;background-color:rgba(255,255,255,.9)}
      .botones-sub{grid-template-columns:repeat(3, minmax(90px,1fr));max-width:95%}
      .botontexto{font-size:20px;padding:8px 4px;min-width:100px;min-height:50px}
      .LINEAS{font-size:32px;padding:15px;min-width:250px}
      .fondo-botones{width:95%;min-height:70vh;margin-top:30px}
      #barra-lateral img{width:120px;height:120px}
      .btn-texto{width:180px;height:52px}
      .panel-carpeta{width:160px}
    }
  </style>
</head>
<body>
  <div class="contenido-principal">
    <div class="fondo-botones">
      <div class="LINEAS" id="btn-lineas" title="Haz clic para cambiar de línea"><strong>DUMMYS</strong></div>
      <div class="barrita">
        <button id="btn-buscar-linea" class="btn-texto"><strong>BUSCAR POR LÍNEA</strong></button>
        <button id="btn-ver-todo" class="btn-texto btn-azul"><strong>VER TODOS LOS ESTÁNDARES</strong></button>
      </div>
      <div id="estado" class="msg">Usa <strong>CONFIGURACIÓN</strong> (protegido) para cargar D00*/R* e imágenes.</div>
      <div id="lista-dummys" class="botones-sub" aria-live="polite"></div>
    </div>
  </div>

  <div id="barra-lateral">
    <a href="../index.html" title="Inicio">
      <img src="imagenes/imagen-casa.png" alt="Casa">
    </a>

    <!-- Pizarrón (se habilita si hay D o R) -->
    <a id="link-pizarron" href="pizarron.htm" title="Pizarrón" class="pizarron-disabled" aria-disabled="true">
      <img id="img-pizarron" src="imagenes/imagen-pizarron.png" alt="Pizarrón">
    </a>
    <div id="pizarron-hint" class="pizarron-hint">Carga D00* o R* desde CONFIGURACIÓN</div>

    <!-- Config con imagen (teclado numérico) -->
    <button id="btn-config" type="button" title="Configuración (bloqueada)" style="background:transparent;border:none;padding:0;cursor:pointer">
      <img id="img-config" src="imagenes/boton config.png"
           alt="Configuración" draggable="false"
           onerror="this.onerror=null; this.src='imagenes/boton config.PNG';"
           style="width:150px;height:150px">
    </button>

    <div class="config-wrapper">
      <div id="config-panel" role="region" aria-label="Opciones de configuración" style="overflow:hidden;max-height:0;transition:max-height .35s ease">
        <label class="btn-texto btn-azul file-button" for="dirInput">
          <strong>SELECCIONAR CARPETA</strong>
          <input id="dirInput" type="file" multiple webkitdirectory />
        </label>
        <button class="btn-texto btn-rojo" id="btn-borrar" type="button"><strong>BORRAR DATOS</strong></button>

        <!-- Botón Copiar desde USB (sin selector de color) -->
        <button class="btn-texto" id="btn-usb" type="button" style="border-color:#0d47a1;color:#0d47a1">
          <strong>COPIAR DESDE USB</strong>
        </button>
        <div class="pizarron-hint" id="usb-hint" style="margin-top:-2px">
          Selecciona carpeta de la USB y luego la carpeta DESTINO donde quieres copiar.
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay/Teclado numérico (CLAVE 99341) -->
  <div id="lock" class="overlay" aria-hidden="true">
    <div class="pad" role="dialog" aria-label="Desbloquear configuración">
      <div class="pad-title">CONFIGURACIÓN</div>
      <div class="pad-sub">Introduce la clave para continuar</div>
      <div id="screen" class="pad-screen" aria-live="polite"></div>
      <div class="grid">
        <div class="key">1</div><div class="key">2</div><div class="key">3</div>
        <div class="key">4</div><div class="key">5</div><div class="key">6</div>
        <div class="key">7</div><div class="key">8</div><div class="key">9</div>
        <div class="key">←</div><div class="key">0</div><div class="key">C</div>
      </div>
      <div class="pad-actions">
        <button class="btn-cancel" id="btn-cancelar">Cancelar</button>
        <button class="btn-clear" id="btn-limpiar">Limpiar</button>
      </div>
    </div>
  </div>

  <script>
    /* ====== Kiosko: bloquear gestos/sistema con mouse/scroll ====== */
    window.addEventListener('contextmenu', e => e.preventDefault());
    window.addEventListener('dragstart',  e => e.preventDefault());
    window.addEventListener('selectstart',e => e.preventDefault());
    window.addEventListener('gesturestart', e => e.preventDefault());
    window.addEventListener('wheel', e => { e.preventDefault(); }, {passive:false});

    const LISTA_ID='lista-dummys', STORAGE_KEY='dummys_rel_paths_master_v2', LINEA_KEY='dummys_linea_actual_v10', MODE_KEY='dummys_modo_vista_v8';
    const STD_PAGE='ESTANDAR.html';
    const $=(id)=>document.getElementById(id);
    let modoVista=readMode()||'D', lineaActual=readLinea()||'';

    /* ===== Utilidades ===== */
    function normalizeRelPath(p){
      let s=String(p||'').trim().replace(/^["']+|["']+$/g,'');
      s=s.replace(/\\/g,'/').replace(/^\/+/, '');
      if(/^dummys\//i.test(s)) s=s.replace(/^dummys\//i,'');
      return s.replace(/\/{2,}/g,'/');
    }
    function getPathSegments(rel){const p=normalizeRelPath(rel), parts=p.split('/'); if(parts.length<=1) return []; parts.pop(); return parts;}

    const COLOR_MAP={
      'rosa':'#e91e63','naranja':'#ff9800','azul':'#2196f3','rojo':'#f44336','verde':'#4caf50','amarillo':'#ffeb3b',
      'morado':'#9c27b0','violeta':'#7e57c2','cafe':'#795548','café':'#795548','gris':'#9e9e9e','negro':'#212121',
      'blanco':'#fafafa','turquesa':'#1abc9c','cyan':'#00bcd4','magenta':'#ff00ff','lila':'#b57edc','plata':'#c0c0c0',
      'plateado':'#c0c0c0','dorado':'#d4af37','celeste':'#87ceeb','fucsia':'#ff1493',
      'azul marino':'#003366','azulmarino':'#003366','marino':'#003366',
      'aqua':'#00ffff','teal':'#008080','beige':'#f5f5dc','oliva':'#808000','olive':'#808000',
      'salmon':'#fa8072','salmón':'#fa8072'
    };

    function deaccent(s){return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');}

    function contrastText(hex){
      let c=(hex||'').replace('#','').trim();
      if(c.length===3) c=c.split('').map(x=>x+x).join('');
      if(c.length!==6) return '#000';
      const r=parseInt(c.slice(0,2),16), g=parseInt(c.slice(2,4),16), b=parseInt(c.slice(4,6),16);
      const yiq=(r*299+g*587+b*114)/1000;
      return (yiq>=140)?'#000':'#fff';
    }

    function naturalCompare(a,b){
      const an=String(a).toUpperCase(),bn=String(b).toUpperCase();const rx=/(\d+)|(\D+)/g;
      const aa=an.match(rx)||[],bb=bn.match(rx)||[];
      for(let i=0;i<Math.max(aa.length,bb.length);i++){
        const x=aa[i]||'',y=bb[i]||'';const nx=parseInt(x,10),ny=parseInt(y,10);
        if(!isNaN(nx)&&!isNaN(ny)){if(nx!==ny)return nx-ny;}else if(x!==y){return x.localeCompare(y);}
      }
      return an.localeCompare(bn);
    }

    function canonLinea(s){ return String(s||'').trim().toUpperCase(); }

    function readStored(){try{const arr=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')||[];return Array.from(new Set(arr.map(normalizeRelPath)));}catch{return[]}}
    function saveLinea(v){try{localStorage.setItem(LINEA_KEY, canonLinea(v||''))}catch{}}
    function readLinea(){try{return canonLinea(localStorage.getItem(LINEA_KEY)||'')}catch{return''}}
    function saveMode(v){try{localStorage.setItem(MODE_KEY,v)}catch{}}
    function readMode(){try{return localStorage.getItem(MODE_KEY)}catch{return null}}

    function isStdHtml(file){const n=(file?.name||'').toLowerCase();return /\.html?$/.test(n);}
    function isStdImage(file){const n=(file?.name||'').toLowerCase();return /\.(jpe?g|png)$/i.test(n);}
    function isRelImagePath(rel){return /\.(jpe?g|png)$/i.test(String(rel).toLowerCase());}

    function parseIdLineFromName(S){
      S=String(S||'').toUpperCase().replace(/\.(HTML?|HTM|JPE?G|PNG)$/,'').trim();

      let m=S.match(/\bR(\d+)\s*[-_–—]\s*(AVI|POLI)\b/);
      if(m){
        const rnum=m[1], suffix=m[2];
        const linea=canonLinea(suffix);
        return {idFull:`R${rnum}-${suffix}`, idKey:`R${rnum}`, linea};
      }

      m=S.match(/\bD([0-9O]{3,4})([A-Z]*)\s*[-_–—]\s*([A-Z0-9]+)\b/);
      if(m){
        const num=m[1].replace(/O/g,'0'), suf=m[2]||'', lin=canonLinea(m[3]);
        return {idFull:'D'+num+suf, idKey:'D'+num, linea:lin};
      }

      m=S.match(/\bD([0-9O]{3,4})([A-Z]*)\b/);
      if(m){
        const num=m[1].replace(/O/g,'0'), suf=m[2]||'';
        return {idFull:'D'+num+suf, idKey:'D'+num, linea:''};
      }
      return{idFull:'',idKey:'',linea:''};
    }

    function getPathColor(rel){
      const parts=normalizeRelPath(rel).split('/');parts.pop();
      for(let i=parts.length-1;i>=0;i--){
        const raw=String(parts[i]||'');const low=raw.toLowerCase();const dea=deaccent(low);
        const m=low.match(/color-#([0-9a-f]{6})/i); if(m) return '#'+m[1];
        const variants=[low,dea,dea.replace(/\s+/g,''),low.replace(/[-_]+/g,''),dea.replace(/[-_]+/g,'')];
        for(const v of variants){ if(COLOR_MAP[v]) return COLOR_MAP[v]; }
        if (COLOR_MAP[low]) return COLOR_MAP[low];
      }
      return null;
    }

    /* ==== corregido: no usar idKey como candidato de imagen ==== */
    function buildNameCandidates(label,linea){
      const L=String(label||'').toUpperCase();
      const LN=String(linea||'').toUpperCase();
      const outs=[];
      if(!L) return outs;
      if(LN){
        outs.push(`${L}-${LN}.jpg`,`${L}-${LN}.jpeg`,`${L}-${LN}.png`);
      }
      outs.push(`${L}.jpg`,`${L}.jpeg`,`${L}.png`);
      return outs;
    }

    /* ==== corregido: storeImageHint ya no usa idKey ==== */
    function storeImageHint(label,linea,list){
      const cand=buildNameCandidates(label,linea).map(s=>s.toUpperCase());
      for(const rel of (list||[])){
        if(!isRelImagePath(rel))continue;
        const base=(rel.split('/').pop()||'').toUpperCase();
        if(cand.includes(base)){
          try{ localStorage.setItem(`dummys_img_for_${String(label).toUpperCase()}__${String(linea||'').toUpperCase()}`, rel); }catch(e){}
          return;
        }
      }
    }

    function buildLineIndex(list){
      const byRelLine=new Map();
      const byLine=new Map();
      const lineColorCounts=new Map();
      const modelColorCache=new Map();

      for (const relRaw of list){
        const rel = normalizeRelPath(relRaw);
        const base=(rel.split('/').pop()||'');
        const nameU=base.toUpperCase();
        const {idFull,idKey,linea}=parseIdLineFromName(nameU);
        if(!idFull) continue;

        const ln = canonLinea(linea || '');
        if(ln){
          byRelLine.set(rel, ln);
          if(!byLine.has(ln)) byLine.set(ln,new Set());
          byLine.get(ln).add(rel);
        }

        if(!modelColorCache.has(idFull)){
          let hex = getPathColor(rel);
          if(!hex){
            /* ==== corregido: sólo leer color por idFull ==== */
            const saved = localStorage.getItem(`dummys_color_for_${idFull}`);
            if(saved && /^#[0-9a-f]{3,6}$/i.test(saved)) hex = saved;
          }
          if(!hex) hex = '#ffeb3b';
          modelColorCache.set(idFull, hex);
        }

        if(ln){
          if(!lineColorCounts.has(ln)) lineColorCounts.set(ln, new Map());
          const cmap = lineColorCounts.get(ln);
          const hex = modelColorCache.get(idFull);
          cmap.set(hex, (cmap.get(hex)||0)+1);
        }
      }

      const lineColors=new Map();
      for(const [ln,cmap] of lineColorCounts.entries()){
        let bestHex=null,best=-1;
        for(const [hex,count] of cmap.entries()){ if(count>best){best=count;bestHex=hex;} }
        if(bestHex) lineColors.set(ln,bestHex);
      }
      return {byRelLine,byLine,lineColors, modelColorCache};
    }

    function buildModelsFromList(list,scopeLine){
      const map=new Map();
      const {byRelLine, modelColorCache}=buildLineIndex(list);
      const scope = canonLinea(scopeLine || '');

      const pool = scope
        ? list.filter(rel => canonLinea(byRelLine.get(normalizeRelPath(rel))||'') === scope)
        : list.slice();

      for(const relRaw of pool){
        const rel=normalizeRelPath(relRaw);
        const base=(rel.split('/').pop()||'');
        const nameU=base.toUpperCase();
        const p=parseIdLineFromName(nameU);
        if(!p.idFull)continue;
        if(!map.has(p.idFull))map.set(p.idFull,{label:p.idFull,idKey:p.idKey,linea:canonLinea(p.linea||''),bg:null,anyRel:rel});
        const hex = modelColorCache.get(p.idFull) || getPathColor(rel);
        if(hex && !map.get(p.idFull).bg) map.get(p.idFull).bg = hex;
      }

      for(const m of map.values()){
        /* ==== corregido: sólo color guardado por label (idFull) ==== */
        const saved=localStorage.getItem(`dummys_color_for_${m.label}`);
        if(saved && /^#[0-9a-f]{3,6}$/i.test(saved)) m.bg=saved;
        if(!m.bg) m.bg='#ffeb3b';
      }

      const arr=[...map.values()];
      arr.sort((a,b)=>naturalCompare(a.label,b.label));
      return arr;
    }

    function render(list){
      const cont=$('lista-dummys'),estado=$('estado');cont.innerHTML='';
      updatePizarronEnabled(list);
      if(!list.length){if(estado)estado.textContent='No hay archivos cargados. Usa “CONFIGURACIÓN”.';return;}

      const {byRelLine,byLine,lineColors}=buildLineIndex(list);
      const lineasDisponibles=Array.from(byLine.keys()).sort(naturalCompare);

      if(modoVista==='LINEAS'){
        if(!lineasDisponibles.length){
          if(estado)estado.textContent='No se detectaron LÍNEAS.';
          const btn=document.createElement('div');btn.className='botontexto';btn.innerHTML='<strong>Sin líneas detectadas</strong>';cont.appendChild(btn);
          return;
        }
        if(estado)estado.textContent='Selecciona una LÍNEA para ver sus estándares';
        lineasDisponibles.forEach(linea=>{
          const btn=document.createElement('div');btn.className='botontexto';btn.innerHTML=`<strong>${linea}</strong>`;
          const hex=lineColors.get(linea) || '#ffeb3b';
          const fg=contrastText(hex);
          btn.style.backgroundColor=hex;btn.style.borderColor=hex;btn.style.color=fg;btn.style.boxShadow='0 4px 10px rgba(0,0,0,.25)';
          btn.addEventListener('click',()=>{lineaActual=linea;saveLinea(lineaActual);modoVista='D';saveMode(modoVista);render(list);});
          cont.appendChild(btn);
        });
        return;
      }

      const modelos=buildModelsFromList(list,lineaActual||undefined);
      if(estado){estado.textContent=lineaActual?`Línea: ${lineaActual}`:'Todos los modelos detectados';}
      if(!modelos.length){const btn=document.createElement('div');btn.className='botontexto';btn.innerHTML='<strong>Sin modelos detectados</strong>';cont.appendChild(btn);return;}

      modelos.forEach(m=>{
        const btn=document.createElement('div');
        btn.className='botontexto';
        btn.innerHTML=`<strong>${m.label}</strong>`;
        if(m.bg){const fg=contrastText(m.bg);btn.style.backgroundColor=m.bg;btn.style.borderColor=m.bg;btn.style.color=fg;btn.style.boxShadow='0 4px 10px rgba(0,0,0,.25)';}
        btn.addEventListener('click',()=>{
          try{
            if(m.bg){
              /* ==== corregido: guardar sólo por label (idFull) ==== */
              localStorage.setItem(`dummys_color_for_${String(m.label).toUpperCase()}`,m.bg);
              localStorage.setItem('dummys_last_color',m.bg);
            }
          }catch(e){}
          const searchPool=lineaActual?list.filter(rel=>canonLinea((byRelLine.get(normalizeRelPath(rel))||''))===canonLinea(lineaActual)):list;

          /* ==== corregido: storeImageHint(label, linea, list) ==== */
          storeImageHint(m.label,(m.linea||lineaActual||'').toUpperCase(),searchPool);

          const lineaSel=(m.linea||lineaActual||'').toUpperCase();
          const parts=[m.label];
          if(lineaSel) parts.push(encodeURIComponent(lineaSel));
          if(m.bg)     parts.push(encodeURIComponent(m.bg));
          // Marcar intención de mantener FS antes de navegar
          try { sessionStorage.setItem('dummys_fs_wanted','1'); } catch(e) {}
          location.href=`${STD_PAGE}#${parts.join(',')}`;
        });
        cont.appendChild(btn);
      });
    }

    function hasAnyStd(list){
      return (list || []).some(rel => {
        const base = (normalizeRelPath(rel).split('/').pop() || '')
                      .toUpperCase()
                      .replace(/\.(HTML?|HTM|JPE?G|PNG)$/, '');
        return /^D[0-9O]{3,4}[A-Z]*\b/.test(base) || /\bR\d+\s*[-_–—]\s*(AVI|POLI)\b/.test(base);
      });
    }
    function updatePizarronEnabled(list){
      const a=$('link-pizarron'),hint=$('pizarron-hint');const ok=hasAnyStd(list);
      if(ok){a.classList.remove('pizarron-disabled');a.setAttribute('href','pizarron.htm');a.removeAttribute('aria-disabled');hint.style.display='none';}
      else{a.classList.add('pizarron-disabled');a.setAttribute('href','#');a.setAttribute('aria-disabled','true');hint.style.display='block';}
    }

    function mergeUnique(a,b){return Array.from(new Set([...(a||[]),...(b||[])]));}
    function handleFileList(fileList){
      const files=Array.from(fileList||[]);let rels=[],ignorados=0;
      files.forEach(file=>{
        const ok=(/\.html?$/i.test(file.name))||(/\.(jpe?g|png)$/i.test(file.name));
        if(!ok){ignorados++;return;}
        const relRaw=file.webkitRelativePath||file.name;
        const rel=normalizeRelPath(relRaw);
        if(!rel){ignorados++;return;}
        rels.push(rel);
      });
      rels=Array.from(new Set(rels));
      const stored=readStored();
      const merged=mergeUnique(stored,rels);
      try{localStorage.setItem(STORAGE_KEY,JSON.stringify(merged));}catch{}
      bumpCatalog();
      render(merged);
      const estado=$('estado');if(estado)estado.textContent=`Cargados: ${rels.length}  |  Ignorados: ${ignorados}`;
    }
    $('dirInput').addEventListener('change',()=>{
      const estado=$('estado');
      if(!$('dirInput').files||!$('dirInput').files.length){if(estado)estado.textContent='No se seleccionaron archivos.';return;}
      if(estado)estado.textContent='Procesando carpeta…';
      handleFileList($('dirInput').files);
    });
    $('btn-borrar').addEventListener('click',()=>{
      if(!confirm('Se borrarán TODOS los datos guardados (tus archivos NO se borran). ¿Continuar?')) return;
      try{
        // Opción 1: limpiar TODO el localStorage
        localStorage.clear();

        // --- Opción 2 (más segura): eliminar solo lo que usa tu app ---
        /*
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(LINEA_KEY);
        localStorage.removeItem(MODE_KEY);
        localStorage.removeItem('dummys_last_color');
        // Y también limpiar todos los hints de imágenes / colores guardados
        for (let k in localStorage) {
          if (k.startsWith("dummys_color_for_") || k.startsWith("dummys_img_for_")) {
            localStorage.removeItem(k);
          }
        }
        */
      }catch(e){}
      bumpCatalog();
      render([]);
      const estado=$('estado');
      if(estado) estado.textContent='Datos borrados. Usa CONFIGURACIÓN.';
      $('dirInput').value='';
      lineaActual='';
      saveLinea('');
    });


    $('btn-buscar-linea').addEventListener('click',()=>{const list=readStored();modoVista='LINEAS';saveMode(modoVista);render(list);});
    $('btn-ver-todo').addEventListener('click',()=>{const list=readStored();lineaActual='';saveLinea(lineaActual);modoVista='D';saveMode(modoVista);render(list);});
    $('btn-lineas').addEventListener('click',()=>{
      if(modoVista!=='D')return;
      const {byLine}=buildLineIndex(readStored());
      const arr=Array.from(byLine.keys()).sort(naturalCompare);
      if(!arr.length)return;
      const i=arr.indexOf(lineaActual);
      lineaActual=(i<0)?arr[0]:arr[(i+1)%arr.length];
      saveLinea(lineaActual);render(readStored());
    });

    function bumpCatalog(){try{localStorage.setItem('dummys_catalog_bump',String(Date.now()));}catch(e){}}

    /* ====== TECLADO NUMÉRICO (clave 99341) ====== */
    const PASS="99341";
    const elOverlay=document.getElementById('lock');
    const elScreen=document.getElementById('screen');
    const btnConfig=document.getElementById('btn-config');
    const btnCancelar=document.getElementById('btn-cancelar');
    const btnLimpiar=document.getElementById('btn-limpiar');
    const keys=[...document.querySelectorAll('.grid .key')];
    const panelConfig=document.getElementById('config-panel');
    let pin=[];

    function openLock(){ elOverlay.classList.add('open'); elOverlay.setAttribute('aria-hidden','false'); pin=[]; drawScreen(); }
    function closeLock(){ elOverlay.classList.remove('open'); elOverlay.setAttribute('aria-hidden','true'); pin=[]; drawScreen(); }
    function drawScreen(){ elScreen.textContent = '*'.repeat(pin.length); }
    function wrongAnim(){ elScreen.style.background='#ffb3b3'; setTimeout(()=>{elScreen.style.background='#ffeb3b';},260); }
    function unlockIfOk(){
      if(pin.length<5) return;
      const code=pin.join('');
      if(code===PASS){
        panelConfig.style.maxHeight='420px';
        closeLock();
      }else{
        pin=[]; drawScreen(); wrongAnim();
      }
    }

    btnConfig.addEventListener('click', openLock);
    btnCancelar.addEventListener('click', closeLock);
    btnLimpiar.addEventListener('click', ()=>{ pin=[]; drawScreen(); });

    keys.forEach(k=>{
      k.addEventListener('click', ()=>{
        const v=k.textContent.trim();
        if(v==='C'){ pin=[]; drawScreen(); return; }
        if(v==='←'){ pin.pop(); drawScreen(); return; }
        if(/[0-9]/.test(v)){
          if(pin.length<5){ pin.push(v); drawScreen(); }
          unlockIfOk();
        }
      });
    });

    /* ===== Pantalla completa persistente (parche) ===== */
    const FS_KEY='dummys_fs_wanted';
    function _fsReq(){
      const el=document.documentElement;
      const req=el.requestFullscreen||el.webkitRequestFullscreen||el.mozRequestFullScreen||el.msRequestFullscreen;
      if(!req) return Promise.resolve(false);
      return req.call(el).then(()=>true).catch(()=>false);
    }
    async function _ensureFSOnce(){ if(document.fullscreenElement) return true; return _fsReq(); }
    function _armFullscreenPersistence(){
      try { sessionStorage.setItem(FS_KEY,'1'); } catch(e){}
      _ensureFSOnce();
      const tryOnUser=async()=>{ await _ensureFSOnce(); };
      window.addEventListener('pointerdown',tryOnUser,{once:true});
      window.addEventListener('keydown',    tryOnUser,{once:true});

      document.addEventListener('visibilitychange', async ()=>{
        const want=sessionStorage.getItem(FS_KEY)==='1';
        if(document.visibilityState==='visible' && want && !document.fullscreenElement){
          await _ensureFSOnce();
        }
      });
      document.addEventListener('fullscreenchange', async ()=>{
        const want=sessionStorage.getItem(FS_KEY)==='1';
        if(want && !document.fullscreenElement){ setTimeout(_ensureFSOnce,50); }
      });
      window.addEventListener('beforeunload',()=>{ try{ sessionStorage.setItem(FS_KEY,'1'); }catch(e){} });
      document.addEventListener('click',(ev)=>{
        const a=ev.target.closest && ev.target.closest('a[href]');
        if(!a) return;
        const href=a.getAttribute('href')||'';
        if(/^(\.|\.{2}|[^:?#]+\.html(\?|#|$))/i.test(href)){
          try{ sessionStorage.setItem(FS_KEY,'1'); }catch(e){}
        }
      },true);
    }

    document.addEventListener('DOMContentLoaded',()=>{
      _armFullscreenPersistence();

      const list=readStored();
      render(list);
      updatePizarronEnabled(list);
      document.getElementById('config-panel').style.maxHeight='0';

      try{
        if (sessionStorage.getItem('dummys_open_config') === '1'){
          sessionStorage.removeItem('dummys_open_config');
          openLock();
        }
      }catch(e){}
    });

    window.addEventListener('storage',(e)=>{
      if(e.key==='dummys_catalog_bump'){
        const list=readStored();
        render(list);
        updatePizarronEnabled(list);
      }
    });

    /* ===== Cursor persistente con C+R ===== */
    const CURSOR_KEY = "dummys_cursor_visible";

    function applyCursorState(visible){
      if(visible){
        document.body.classList.remove("no-cursor");
      } else {
        document.body.classList.add("no-cursor");
      }
      try{
        localStorage.setItem(CURSOR_KEY, visible ? "1" : "0");
      }catch(e){}
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      const saved = localStorage.getItem(CURSOR_KEY);
      if(saved === null){
        applyCursorState(false); // arranca oculto
      } else {
        applyCursorState(saved === "1");
      }
    });

    const pressedKeys = new Set();
    window.addEventListener("keydown", (e)=>{
      pressedKeys.add(e.key.toLowerCase());
      if(pressedKeys.has("c") && pressedKeys.has("r")){
        const isVisible = !document.body.classList.contains("no-cursor");
        applyCursorState(!isVisible);
      }
    });
    window.addEventListener("keyup", (e)=>{
      pressedKeys.delete(e.key.toLowerCase());
    });
  </script>
</body>
</html>
